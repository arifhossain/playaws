pipeline {
    agent any

    stages {
        stage('Clone repo') {
            steps {
                checkout scm
            }
        }
        stage('Create stack') {
            steps {
                 sh '''RESULT=(`aws sts assume-role \
                --role-arn arn:aws:iam::ABCDEF:role/idfp-dev-jenkins-role \
                --role-session-name $(date +"%s") \
                --query '[Credentials.AccessKeyId,Credentials.SecretAccessKey,Credentials.SessionToken]' \
                --output text`)
                
                export AWS_ACCESS_KEY_ID=${RESULT[0]}
                export AWS_SECRET_ACCESS_KEY=${RESULT[1]}
                export AWS_SECURITY_TOKEN=${RESULT[2]}
                export AWS_SESSION_TOKEN=${AWS_SECURITY_TOKEN}
                
                aws cloudformation create-stack \
                --stack-name jenkinstest \
                --template-body file://basic-vpc-cft.yaml \
                --region us-east-1 \
                --capabilities CAPABILITY_NAMED_IAM'''
            }
        }
    }
}
